<div class="details-container">
  @if (!ticket()) {
  <div class="empty-selection">
    <mat-icon>chat_bubble_outline</mat-icon>
    <h2>Select a ticket to view details</h2>
  </div>
  } @else {
  <div class="header">
    <div class="title-row">
      <h1>{{ ticket()!.subject }}</h1>
      <div class="actions">
        @if (ticket()!.status !== TicketStatus.Closed && ticket()!.status !== TicketStatus.Rejected)
        {
        <button mat-stroked-button color="primary" (click)="resolve.emit(ticket()!.id)">
          <mat-icon>check</mat-icon> Resolve
        </button>
        }
      </div>
    </div>

    <div class="meta-row">
      <mat-form-field appearance="outline" class="status-select">
        <mat-label>Status</mat-label>
        <mat-select [value]="ticket()!.status" (selectionChange)="onStatusChange($event)">
          @for (opt of statusOptions; track opt.value) {
          <mat-option [value]="opt.value">{{ opt.label }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="priority-select">
        <mat-label>Priority</mat-label>
        <mat-select [value]="ticket()!.priority" (selectionChange)="onPriorityChange($event)">
          @for (opt of priorityOptions; track opt.value) {
          <mat-option [value]="opt.value">{{ opt.label }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <span class="info"> From: {{ ticket()!.email }} | Phone: {{ ticket()!.phone }} </span>
    </div>

    <!-- Context Row (Site & Account) -->
    <div class="context-row">
      @if (ticket()!.siteNameEn) {
      <div class="context-item">
        <mat-icon>business</mat-icon>
        <span class="label">Site:</span>
        <span class="value">{{ ticket()!.siteNameEn }}</span>
      </div>
      } @if (ticket()!.accountNameEn) {
      <div class="context-item">
        <mat-icon>person</mat-icon>
        <span class="label">Account:</span>
        <span class="value">{{ ticket()!.accountNameEn }}</span>
      </div>
      } @if (ticket()!.isInProducts) {
      <div class="context-item highlight-product">
        <mat-icon>inventory_2</mat-icon>
        <span class="label">In Products</span>
      </div>
      } @if (ticket()!.isInSupport) {
      <div class="context-item highlight-support">
        <mat-icon>support_agent</mat-icon>
        <span class="label">In Support</span>
      </div>
      }
    </div>
  </div>

  <div class="conversation">
    <!-- Original Description -->
    <div class="message client">
      <div class="message-header">
        <span class="sender">Original Request</span>
        <span class="time">{{ ticket()!.createdAt | date : 'short' }}</span>
      </div>
      <div class="message-content">
        {{ ticket()!.description }}
      </div>
    </div>

    <!-- Message History -->
    @for (msg of ticket()!.messages; track msg.id) {
    <div class="message" [class]="msg.sender">
      <div class="message-header">
        <span class="sender">
          {{ msg.sender === 'client' ? 'Client' : msg.sender === 'system' ? 'System' : 'Agent' }}
        </span>
        <span class="time">{{ msg.createdAt | date : 'short' }}</span>
      </div>
      <div class="message-content">
        {{ msg.content }}
      </div>
    </div>
    }
  </div>

  <div class="reply-box">
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Reply to customer...</mat-label>
      <textarea
        matInput
        [(ngModel)]="replyText"
        rows="3"
        placeholder="Type your response here..."
        [disabled]="ticket()!.status === TicketStatus.Closed"
      ></textarea>
    </mat-form-field>
    <div class="reply-actions">
      <button
        mat-flat-button
        color="primary"
        [disabled]="!replyText() || ticket()!.status === TicketStatus.Closed"
        (click)="sendReply()"
      >
        <mat-icon>send</mat-icon> Send Reply
      </button>
    </div>
  </div>
  }
</div>
